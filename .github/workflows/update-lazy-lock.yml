name: Update lazy-lock.json

on:
  pull_request:
    paths:
      - 'config/nvim/lua/plugins/**/*.lua'
    types:
      - opened
      - synchronize

jobs:
  update-lazy-lock:
    if: github.actor == 'renovate[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Neovim
        uses: rhysd/action-setup-vim@v1
        with:
          neovim: true
          version: stable

      - name: Update lazy-lock.json
        run: |
          # Create minimal init.lua to bootstrap lazy.nvim
          mkdir -p ~/.config/nvim
          cat > ~/.config/nvim/init.lua << 'EOF'
          local lazypath = vim.fn.stdpath('data') .. '/lazy/lazy.nvim'
          if not vim.loop.fs_stat(lazypath) then
            vim.fn.system({
              'git',
              'clone',
              '--filter=blob:none',
              'https://github.com/folke/lazy.nvim.git',
              '--branch=stable',
              lazypath,
            })
          end
          vim.opt.rtp:prepend(lazypath)

          -- Copy user's lazy config
          require('lazy').setup('plugins', {
            lockfile = vim.fn.getcwd() .. '/config/nvim/lazy-lock.json',
            performance = {
              rtp = {
                disabled_plugins = {
                  'gzip',
                  'matchit',
                  'matchparen',
                  'netrwPlugin',
                  'tarPlugin',
                  'tohtml',
                  'tutor',
                  'zipPlugin',
                },
              },
            },
          })
          EOF

          # Create symlink to plugins directory
          ln -s $GITHUB_WORKSPACE/config/nvim/lua ~/.config/nvim/lua

          # Update plugins and generate new lock file
          nvim --headless +LazyUpdate +qa

          # Copy the updated lock file back
          cp ~/.local/share/nvim/lazy-lock.json config/nvim/lazy-lock.json

      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          if git diff --quiet config/nvim/lazy-lock.json; then
            echo "No changes to lazy-lock.json"
          else
            git add config/nvim/lazy-lock.json
            git commit -m "chore: update lazy-lock.json"
            git push
          fi
