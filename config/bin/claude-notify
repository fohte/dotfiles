#!/usr/bin/env bash
#
# claude-notify - Claude Code notification handler for macOS
#
# Reads JSON input from stdin and displays macOS push notification.
# Clicking the notification will jump to the tmux session/window/pane.
#
# Requirements:
#   - jq
#   - terminal-notifier
#   - tmux
#
# Usage:
#   echo '{"title":"Test","message":"Hello"}' | claude-notify

set -euo pipefail

# Read JSON input from stdin
json_input=$(cat)

# Parse message and title from JSON using jq
title=$(echo "$json_input" | jq -r '.title // "Claude Code"')
message=$(echo "$json_input" | jq -r '.message // "Notification"')

# Get tmux session info from TMUX_PANE environment variable
# Note: tmux display-message -p returns the currently focused pane,
# so when running from a background pane (e.g., Claude Code in another window),
# the restoration target would be wrong. Use TMUX_PANE directly instead.
tmux_session=$(tmux display-message -p -t "$TMUX_PANE" '#S')
tmux_window_info=$(tmux-name info --no-icon "$TMUX_PANE")

# Build subtitle from tmux info
subtitle="\\[$tmux_session] $tmux_window_info"

# Build the command to execute when notification is clicked
click_command=$(
  cat << EOF
zsh -c "
client_name=\\\$(tmux list-clients -F '#{client_name}' | head -n1)
tmux switch-client -c \"\\\$client_name\" -t '$TMUX_PANE'
open -a WezTerm
"
EOF
)

# Use terminal-notifier with click action
terminal-notifier \
  -title "$title" \
  -subtitle "$subtitle" \
  -message "$message" \
  -sound Glass \
  -execute "$click_command"
