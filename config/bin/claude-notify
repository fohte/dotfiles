#!/usr/bin/env bash
#
# claude-notify - Claude Code notification handler for macOS
#
# Reads JSON input from stdin and displays macOS push notification.
# Clicking the notification will jump to the tmux session/window/pane.
#
# Requirements:
#   - jq
#   - terminal-notifier
#   - tmux
#
# Usage:
#   echo '{"title":"Test","message":"Hello"}' | claude-notify

set -euo pipefail

# Read JSON input from stdin
json_input=$(cat)

# Parse message and title from JSON using jq
title=$(echo "$json_input" | jq -r '.title // "Claude Code"')
message=$(echo "$json_input" | jq -r '.message // "Notification"')

# Get tmux session info
tmux_session=$(tmux display-message -p '#S')
tmux_window=$(tmux display-message -p '#I')
tmux_pane=$(tmux display-message -p '#P')

# Add tmux session to title
title="$title [$tmux_session]"

# Build the command to execute when notification is clicked
click_command=$(
  cat << EOF
zsh -c "
client_name=\\\$(tmux list-clients -F '#{client_name}' | head -n1)
tmux switch-client -c \"\\\$client_name\" -t '$tmux_session:$tmux_window.$tmux_pane'
open -a WezTerm
"
EOF
)

# Use terminal-notifier with click action
terminal-notifier \
  -title "$title" \
  -message "$message" \
  -sound Glass \
  -execute "$click_command"
