#!/usr/bin/env bash
#
# claude-pr-draft - PR body draft management tool for Claude Code
#
# This command is designed to be used by Claude Code to create and manage
# PR body drafts with user review via Neovim in a new Wezterm window.
#
# See also: config/claude/commands/create-pr.md
# (When modifying this script, update the command file as well)
#
# Usage:
#   claude-pr-draft new
#   claude-pr-draft review <filepath>
#   claude-pr-draft submit <filepath> [gh pr create options...]
#
set -euo pipefail

# Show help
show_help() {
  cat << EOF
PR body draft management tool for Claude Code

Usage: claude-pr-draft [--help] <command> [args]

Commands:
  new                          Create a new temporary draft file and output its path
                               Accepts content from stdin if provided
  review <filepath>            Open the draft file in Neovim (new Wezterm window)
  submit <filepath> [options]  Create PR with the draft file as body

Draft File Format:
  The draft file uses YAML frontmatter to control PR creation:

  ---
  title: "PR title here"
  english: true
  approve: false
  ---

  PR body content here...

  Frontmatter fields:
    title    - PR title (required for submit)
    english  - If true, submit fails when title or body contains Japanese
    approve  - Must be set to true before submit (prevents accidental submission)

Examples:
  # Create a new draft file with content from stdin (using heredoc)
  echo "PR body content..." | claude-pr-draft new

  # Open draft file for user review
  claude-pr-draft review /tmp/pr-body-draft.xxx.md

  # Create PR after user approval (title is taken from frontmatter)
  claude-pr-draft submit /tmp/pr-body-draft.xxx.md --base main
EOF
}

# Parse options
while [[ $# -gt 0 ]]; do
  case "$1" in
    -h | --help)
      show_help
      exit 0
      ;;
    -*)
      echo "Error: Unknown option: $1" >&2
      echo "Run 'claude-pr-draft --help' for usage information" >&2
      exit 1
      ;;
    *)
      # First non-option argument is the subcommand
      break
      ;;
  esac
done

# Parse command line arguments
SUBCOMMAND="${1:-}"
shift || true

# Check if current repository is public
is_public_repo() {
  local visibility
  visibility=$(gh repo view --json isPrivate -q '.isPrivate' 2> /dev/null)
  [[ "$visibility" == "false" ]]
}

# Create a new temporary draft file
new_draft() {
  local draft_file
  draft_file=$(mktemp /tmp/pr-body-draft.XXXXXX.md)

  # Determine english default based on repo visibility
  local english_default="false"
  if is_public_repo; then
    english_default="true"
  fi

  # Write YAML frontmatter template
  cat > "$draft_file" << FRONTMATTER
---
title: ""
english: ${english_default}
approve: false
---

FRONTMATTER

  # If stdin is available, append content from stdin
  if [ ! -t 0 ]; then
    cat >> "$draft_file"
  fi

  # Create lock file to prevent accidental submission without review
  touch "${draft_file}.lock"

  echo "$draft_file"
}

# Review draft in Neovim (new Wezterm window)
review_draft() {
  local filepath="$1"
  local lock_file="${filepath}.lock"

  if [[ ! -f "$filepath" ]]; then
    echo "Error: File not found: $filepath" >&2
    exit 1
  fi

  # Create a wrapper script that removes the lock file after Neovim exits
  local wrapper_script
  wrapper_script=$(mktemp /tmp/nvim-wrapper.XXXXXX.sh)
  cat > "$wrapper_script" << EOF
#!/usr/bin/env bash
nvim "$filepath"
rm -f "$lock_file"
EOF
  chmod +x "$wrapper_script"

  # Use nohup to run in background without blocking
  nohup wezterm start -- "$wrapper_script" > /dev/null 2>&1 &
}

# Extract YAML frontmatter as raw YAML
get_frontmatter() {
  local filepath="$1"
  sed -n '2,/^---$/p' "$filepath" | sed '$d'
}

# Extract YAML frontmatter value by key using yq
# Usage: get_frontmatter_value <filepath> <key>
get_frontmatter_value() {
  local filepath="$1"
  local key="$2"
  get_frontmatter "$filepath" | yq -r ".$key // \"\""
}

# Extract body content (everything after frontmatter)
get_body_content() {
  local filepath="$1"
  sed '1,/^---$/d' "$filepath" | sed '1,/^---$/d'
}

# Check if text contains Japanese characters
contains_japanese() {
  local text="$1"
  echo "$text" | grep -qE '[\p{Hiragana}\p{Katakana}\p{Han}]' 2> /dev/null ||
    echo "$text" | grep -qE '[ぁ-んァ-ン一-龯]'
}

# Submit PR with draft file as body
submit_pr() {
  local filepath="$1"
  local lock_file="${filepath}.lock"
  shift

  if [[ ! -f "$filepath" ]]; then
    echo "Error: File not found: $filepath" >&2
    exit 1
  fi

  # Check if lock file exists (review not completed)
  if [[ -f "$lock_file" ]]; then
    echo "Error: Please complete the review in the editor before submitting the PR." >&2
    exit 1
  fi

  # Parse frontmatter
  local title english approve
  title=$(get_frontmatter_value "$filepath" "title")
  english=$(get_frontmatter_value "$filepath" "english")
  approve=$(get_frontmatter_value "$filepath" "approve")

  # Validate approve flag
  if [[ "$approve" != "true" ]]; then
    echo "Error: Please set 'approve: true' in the frontmatter to submit the PR." >&2
    exit 1
  fi

  # Validate title is not empty
  if [[ -z "$title" ]]; then
    echo "Error: Please set a title in the frontmatter." >&2
    exit 1
  fi

  # Check for Japanese characters if english: true
  if [[ "$english" == "true" ]]; then
    local body
    body=$(get_body_content "$filepath")

    if contains_japanese "$title"; then
      echo "Error: Title contains Japanese characters but 'english: true' is set." >&2
      echo "Please translate the title to English or set 'english: false'." >&2
      exit 1
    fi

    if contains_japanese "$body"; then
      echo "Error: Body contains Japanese characters but 'english: true' is set." >&2
      echo "Please translate the body to English or set 'english: false'." >&2
      exit 1
    fi
  fi

  # Create temporary file with body content only (without frontmatter)
  local body_file
  body_file=$(mktemp /tmp/pr-body.XXXXXX.md)
  get_body_content "$filepath" > "$body_file"

  # Pass remaining arguments to gh pr create
  gh pr create --title "$title" --body-file "$body_file" "$@"

  # Clean up temporary body file
  rm -f "$body_file"
}

# Main execution
case "$SUBCOMMAND" in
  new)
    new_draft
    ;;
  review)
    if [[ $# -ne 1 ]]; then
      echo "Error: review requires exactly 1 argument: <filepath>" >&2
      exit 1
    fi
    review_draft "$1"
    ;;
  submit)
    if [[ $# -lt 1 ]]; then
      echo "Error: submit requires at least 1 argument: <filepath> [gh pr create options...]" >&2
      exit 1
    fi
    submit_pr "$@"
    ;;
  "")
    echo "Error: No command specified" >&2
    echo "Run 'claude-pr-draft --help' for usage information" >&2
    exit 1
    ;;
  *)
    echo "Error: Unknown command: $SUBCOMMAND" >&2
    echo "Run 'claude-pr-draft --help' for usage information" >&2
    exit 1
    ;;
esac
