#!/usr/bin/env bash
#
# claude-pr-draft - PR body draft management tool for Claude Code
#
# This command is designed to be used by Claude Code to create and manage
# PR body drafts with user review via Neovim in a new Wezterm window.
#
# See also: config/claude/commands/create-pr.md
# (When modifying this script, update the command file as well)
#
# Usage:
#   claude-pr-draft new [--title "PR title"]
#   claude-pr-draft review <filepath>
#   claude-pr-draft submit <filepath> [gh pr create options...]
#
set -euo pipefail

# Show help
show_help() {
  cat << EOF
PR body draft management tool for Claude Code

Usage: claude-pr-draft [--help] <command> [args]

Commands:
  new [--title "title"]        Create a new temporary draft file and output its path
                               Accepts content from stdin if provided
  review <filepath>            Open the draft file in Neovim (new Wezterm window)
  submit <filepath> [options]  Create PR with the draft file as body

Draft File Format:
  The draft file uses YAML frontmatter to control PR creation:

  ---
  title: "PR title here"
  english: true
  approve: false
  ---

  PR body content here...

  Frontmatter fields:
    title    - PR title (required for submit)
    english  - If true, submit fails when title or body contains Japanese
    approve  - Set to true to approve; file hash is saved on editor exit
               Any modification after approval invalidates the hash

Examples:
  # Create a new draft file with title and content from stdin
  echo "PR body content..." | claude-pr-draft new --title "Add new feature"

  # Open draft file for user review
  claude-pr-draft review /tmp/pr-body-draft.xxx.md

  # Create PR after user approval (title is taken from frontmatter)
  claude-pr-draft submit /tmp/pr-body-draft.xxx.md --base main
EOF
}

# Parse options
while [[ $# -gt 0 ]]; do
  case "$1" in
    -h | --help)
      show_help
      exit 0
      ;;
    -*)
      echo "Error: Unknown option: $1" >&2
      echo "Run 'claude-pr-draft --help' for usage information" >&2
      exit 1
      ;;
    *)
      # First non-option argument is the subcommand
      break
      ;;
  esac
done

# Parse command line arguments
SUBCOMMAND="${1:-}"
shift || true

# Check if current repository is public
is_public_repo() {
  local visibility
  visibility=$(gh repo view --json isPrivate -q '.isPrivate' 2> /dev/null)
  [[ "$visibility" == "false" ]]
}

# Create a new temporary draft file
new_draft() {
  local title=""

  # Parse options for new subcommand
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --title)
        if [[ $# -lt 2 ]]; then
          echo "Error: --title requires a value" >&2
          exit 1
        fi
        title="$2"
        shift 2
        ;;
      *)
        echo "Error: Unknown option for 'new': $1" >&2
        exit 1
        ;;
    esac
  done

  local draft_file
  draft_file=$(mktemp /tmp/pr-body-draft.XXXXXX.md)

  # Determine english default based on repo visibility
  local english_default="false"
  if is_public_repo; then
    english_default="true"
  fi

  # Write YAML frontmatter template
  cat > "$draft_file" << FRONTMATTER
---
title: "${title}"
english: ${english_default}
approve: false
---

FRONTMATTER

  # If stdin is available, append content from stdin
  if [ ! -t 0 ]; then
    cat >> "$draft_file"
  fi

  echo "$draft_file"
}

# Calculate hash of file content
calc_file_hash() {
  local filepath="$1"
  shasum -a 256 "$filepath" | cut -d' ' -f1
}

# Review draft in Neovim (new Wezterm window)
review_draft() {
  local filepath="$1"
  local lock_file="${filepath}.lock"
  local approve_file="${filepath}.approve"

  if [[ ! -f "$filepath" ]]; then
    echo "Error: File not found: $filepath" >&2
    exit 1
  fi

  # Skip if Neovim is already open for this file
  if [[ -f "$lock_file" ]]; then
    return 0
  fi

  # Create a wrapper script that handles approval after Neovim exits
  local wrapper_script
  wrapper_script=$(mktemp /tmp/nvim-wrapper.XXXXXX.sh)
  cat > "$wrapper_script" << 'WRAPPER_EOF'
#!/usr/bin/env bash
set -euo pipefail

filepath="$1"
lock_file="${filepath}.lock"
approve_file="${filepath}.approve"

nvim "$filepath"

# Check approve value in frontmatter
approve=$(sed -n '2,/^---$/p' "$filepath" | sed '$d' | yq -r '.approve // "false"')

if [[ "$approve" == "true" ]]; then
  # Save hash of file content for verification
  shasum -a 256 "$filepath" | cut -d' ' -f1 > "$approve_file"
  echo "Approved. Hash saved."
else
  # Remove approve file if exists (rejected)
  rm -f "$approve_file"
  echo "Rejected or not approved."
fi

# Remove lock file (Neovim is closed)
rm -f "$lock_file"
WRAPPER_EOF
  chmod +x "$wrapper_script"

  # Mark as currently being reviewed
  touch "$lock_file"

  # Use nohup to run in background without blocking
  nohup wezterm start -- "$wrapper_script" "$filepath" > /dev/null 2>&1 &
}

# Extract YAML frontmatter as raw YAML
get_frontmatter() {
  local filepath="$1"
  sed -n '2,/^---$/p' "$filepath" | sed '$d'
}

# Extract YAML frontmatter value by key using yq
# Usage: get_frontmatter_value <filepath> <key>
get_frontmatter_value() {
  local filepath="$1"
  local key="$2"
  get_frontmatter "$filepath" | yq -r ".$key // \"\""
}

# Extract body content (everything after frontmatter)
get_body_content() {
  local filepath="$1"
  # BSD sed: '1,/^---$/d' deletes from line 1 to the first line matching ^---$
  # after line 1 (i.e., the closing ---), so one sed is enough
  sed '1,/^---$/d' "$filepath"
}

# Check if text contains Japanese characters
contains_japanese() {
  local text="$1"
  # Use Perl for proper Unicode property support (grep doesn't support \p{...})
  ! echo "$text" | perl -CSD -ne 'exit 1 if /[\p{Hiragana}\p{Katakana}\p{Han}]/'
}

# Submit PR with draft file as body
submit_pr() {
  local filepath="$1"
  local lock_file="${filepath}.lock"
  local approve_file="${filepath}.approve"
  shift

  if [[ ! -f "$filepath" ]]; then
    echo "Error: File not found: $filepath" >&2
    exit 1
  fi

  # Check if Neovim is still open
  if [[ -f "$lock_file" ]]; then
    echo "Error: Please close the editor before submitting the PR." >&2
    exit 1
  fi

  # Check if approve file exists (rejected if not)
  if [[ ! -f "$approve_file" ]]; then
    echo "Error: PR was not approved. Please run 'review' and set 'approve: true'." >&2
    exit 1
  fi

  # Verify hash matches (detect tampering after approval)
  local saved_hash current_hash
  saved_hash=$(cat "$approve_file")
  current_hash=$(calc_file_hash "$filepath")

  if [[ "$saved_hash" != "$current_hash" ]]; then
    echo "Error: File has been modified after approval. Please run 'review' again." >&2
    exit 1
  fi

  # Parse frontmatter
  local title english
  title=$(get_frontmatter_value "$filepath" "title")
  english=$(get_frontmatter_value "$filepath" "english")

  # Validate title is not empty
  if [[ -z "$title" ]]; then
    echo "Error: Please set a title in the frontmatter." >&2
    exit 1
  fi

  # Check for Japanese characters if english: true
  if [[ "$english" == "true" ]]; then
    local body
    body=$(get_body_content "$filepath")

    if contains_japanese "$title"; then
      echo "Error: Title contains Japanese characters but 'english: true' is set." >&2
      echo "Please translate the title to English or set 'english: false'." >&2
      exit 1
    fi

    if contains_japanese "$body"; then
      echo "Error: Body contains Japanese characters but 'english: true' is set." >&2
      echo "Please translate the body to English or set 'english: false'." >&2
      exit 1
    fi
  fi

  # Create temporary file with body content only (without frontmatter)
  local body_file
  body_file=$(mktemp /tmp/pr-body.XXXXXX.md)
  get_body_content "$filepath" > "$body_file"

  # Pass remaining arguments to gh pr create
  gh pr create --title "$title" --body-file "$body_file" "$@"

  # Clean up temporary body file
  rm -f "$body_file"
}

# Main execution
case "$SUBCOMMAND" in
  new)
    new_draft "$@"
    ;;
  review)
    if [[ $# -ne 1 ]]; then
      echo "Error: review requires exactly 1 argument: <filepath>" >&2
      exit 1
    fi
    review_draft "$1"
    ;;
  submit)
    if [[ $# -lt 1 ]]; then
      echo "Error: submit requires at least 1 argument: <filepath> [gh pr create options...]" >&2
      exit 1
    fi
    submit_pr "$@"
    ;;
  "")
    echo "Error: No command specified" >&2
    echo "Run 'claude-pr-draft --help' for usage information" >&2
    exit 1
    ;;
  *)
    echo "Error: Unknown command: $SUBCOMMAND" >&2
    echo "Run 'claude-pr-draft --help' for usage information" >&2
    exit 1
    ;;
esac
