#!/bin/bash
# Dynamic skill generator for Claude Code.
# Reads a config.yaml with variables and a gomplate template,
# evaluates variable commands, and renders the final Markdown to stdout.
#
# Usage: gen-dynamic-skill <skill-name>
#
# Config location: ~/.claude/dynamic-skills/<skill-name>/config.yaml
# Template location: resolved from config.yaml's "template" field
#
# config.yaml format:
#   variables:
#     <name>: <shell command whose stdout becomes the variable value>
#   template: <template file path relative to config.yaml>
#
# Variable values are passed to gomplate as a YAML datasource "vars".
# In templates, access them via: {{ (ds "vars").<name> }}
# If a command outputs JSON, it is accessible as nested objects.

set -euo pipefail

skill_name="${1:?Usage: gen-dynamic-skill <skill-name>}"
skill_dir="${HOME}/.claude/dynamic-skills/${skill_name}"
config="${skill_dir}/config.yaml"

if [[ ! -f "$config" ]]; then
  echo "Error: config not found: $config" >&2
  exit 1
fi

# Evaluate each variable command and build a YAML string
vars_yaml=""
while IFS= read -r key; do
  cmd=$(yq -r ".variables.\"$key\"" "$config")
  value=$(eval "$cmd" 2> /dev/null || true)
  # If value looks like JSON object/array, inline it as-is for YAML parsing
  if [[ "$value" =~ ^[\{\[] ]]; then
    vars_yaml+="${key}: ${value}"$'\n'
  else
    vars_yaml+="${key}: ${value}"$'\n'
  fi
done < <(yq -r '.variables | keys[]' "$config")

template=$(yq -r '.template' "$config")

echo "$vars_yaml" | gomplate \
  -d "vars=stdin:///vars.yaml" \
  -f "${skill_dir}/${template}"
