#!/bin/bash
set -euo pipefail

# gh-check-pr-review: Fetch PR review comments in a concise format for LLM agents

print_diff() {
  local path="$1"
  local hunk_header="$2"
  {
    echo "diff --git a/$path b/$path"
    echo "--- a/$path"
    echo "+++ b/$path"
    echo "$hunk_header"
    cat
  } | delta --paging=never --line-numbers
}

show_help() {
  cat << EOF
gh-check-pr-review - Fetch PR review comments in a concise format

Usage:
  gh-check-pr-review <pr-number> [options]

Options:
  -R <owner/repo>   Target repository (default: current repo)
  -a, --all         Include resolved comments (default: only unresolved)
  -h, --help        Show this help

Output Format:
  Groups comments by thread, showing:
  - Author and timestamp
  - Diff context with line numbers
  - Comment body (rendered with glow if available)
  - Replies with tree structure

Examples:
  gh-check-pr-review 123
  gh-check-pr-review 123 --all
  gh-check-pr-review 456 -R owner/repo
EOF
}

die() {
  echo "Error: $1" >&2
  exit 1
}

get_repo_from_arg_or_current() {
  local repo="$1"
  if [[ -n "$repo" ]]; then
    echo "$repo"
  else
    gh repo view --json nameWithOwner --jq '.nameWithOwner'
  fi
}

format_datetime() {
  local iso_date="$1"
  # Convert ISO 8601 to readable format
  if command -v gdate &>/dev/null; then
    gdate -d "$iso_date" '+%Y-%m-%d %H:%M'
  elif date --version &>/dev/null 2>&1; then
    date -d "$iso_date" '+%Y-%m-%d %H:%M'
  else
    # macOS date fallback
    echo "$iso_date" | sed 's/T/ /; s/Z//; s/\.[0-9]*//' | cut -c1-16
  fi
}

print_comment() {
  local comment="$1"
  local indent="$2"
  local is_reply="$3"
  local is_resolved="$4"

  local path author created_at diff_hunk body

  path=$(echo "$comment" | jq -r '.path')
  author=$(echo "$comment" | jq -r '.author.login // "unknown"')
  created_at=$(echo "$comment" | jq -r '.createdAt')
  diff_hunk=$(echo "$comment" | jq -r '.diffHunk // empty')
  body=$(echo "$comment" | jq -r '.body')

  local formatted_date
  formatted_date=$(format_datetime "$created_at")

  # Print comment header with optional tree prefix
  # 48;5;238 = dark gray background
  if [[ "$is_reply" == "true" ]]; then
    printf '%s└─ \e[48;5;238m @%s (%s) \e[0m\n' "$indent" "$author" "$formatted_date"
  else
    # Build resolved indicator (dim text) for root comments only
    local resolved_indicator=""
    if [[ "$is_resolved" == "true" ]]; then
      resolved_indicator=" \e[2m[resolved]\e[0m"
    fi
    printf '\e[48;5;238m @%s (%s) \e[0m%b\n' "$author" "$formatted_date" "$resolved_indicator"
  fi

  # Print diff context (only for root comments)
  if [[ "$is_reply" != "true" && -n "$diff_hunk" ]]; then
    local hunk_header
    hunk_header=$(echo "$diff_hunk" | head -n 1)
    echo "$diff_hunk" | tail -n 3 | print_diff "$path" "$hunk_header"
  fi

  # Print comment body with glow (if available)
  if command -v glow &>/dev/null; then
    if [[ "$is_reply" == "true" ]]; then
      echo "$body" | glow - 2>/dev/null | sed "s/^/${indent}   /"
    else
      echo "$body" | glow - 2>/dev/null
    fi
  else
    if [[ "$is_reply" == "true" ]]; then
      echo "$body" | sed "s/^/${indent}   /"
    else
      echo "$body"
    fi
  fi
  echo ""
}

fetch_review_threads() {
  local owner="$1"
  local repo="$2"
  local pr_number="$3"
  local include_resolved="$4"

  local query='
query($owner: String!, $repo: String!, $pr: Int!, $cursor: String) {
  repository(owner: $owner, name: $repo) {
    pullRequest(number: $pr) {
      reviewThreads(first: 100, after: $cursor) {
        pageInfo {
          hasNextPage
          endCursor
        }
        nodes {
          isResolved
          comments(first: 100) {
            nodes {
              databaseId
              author { login }
              body
              createdAt
              path
              line
              originalLine
              diffHunk
              replyTo { databaseId }
            }
          }
        }
      }
    }
  }
}'

  local all_threads="[]"
  local cursor=""
  local has_next_page="true"

  while [[ "$has_next_page" == "true" ]]; do
    local result
    if [[ -z "$cursor" ]]; then
      result=$(gh api graphql -f query="$query" -F owner="$owner" -F repo="$repo" -F pr="$pr_number")
    else
      result=$(gh api graphql -f query="$query" -F owner="$owner" -F repo="$repo" -F pr="$pr_number" -f cursor="$cursor")
    fi

    local threads
    threads=$(echo "$result" | jq '.data.repository.pullRequest.reviewThreads.nodes')
    all_threads=$(echo "$all_threads $threads" | jq -s 'add')

    has_next_page=$(echo "$result" | jq -r '.data.repository.pullRequest.reviewThreads.pageInfo.hasNextPage')
    cursor=$(echo "$result" | jq -r '.data.repository.pullRequest.reviewThreads.pageInfo.endCursor')
  done

  # Filter by resolved status if needed
  if [[ "$include_resolved" == "false" ]]; then
    echo "$all_threads" | jq '[.[] | select(.isResolved == false)]'
  else
    echo "$all_threads"
  fi
}

format_threads() {
  local threads_json="$1"

  local thread_count
  thread_count=$(echo "$threads_json" | jq 'length')

  if [[ "$thread_count" == "0" ]]; then
    echo "No review comments found."
    return 0
  fi

  # Process each thread
  echo "$threads_json" | jq -c '.[]' | while read -r thread; do
    local comments is_resolved
    comments=$(echo "$thread" | jq -c '.comments.nodes')
    is_resolved=$(echo "$thread" | jq -r '.isResolved')

    # Get root comment (no replyTo)
    local root_comment
    root_comment=$(echo "$comments" | jq -c '[.[] | select(.replyTo == null)] | .[0]')

    if [[ "$root_comment" != "null" ]]; then
      print_comment "$root_comment" "" "false" "$is_resolved"

      local root_id
      root_id=$(echo "$root_comment" | jq -r '.databaseId')

      # Find and print replies
      echo "$comments" | jq -c --argjson parent_id "$root_id" '[.[] | select(.replyTo.databaseId == $parent_id)] | sort_by(.createdAt) | .[]' 2>/dev/null | while read -r reply; do
        print_comment "$reply" "  " "true" "$is_resolved"
      done
    fi
  done
}

main() {
  local repo=""
  local pr_number=""
  local include_resolved="false"

  while [[ $# -gt 0 ]]; do
    case "$1" in
      -h | --help)
        show_help
        exit 0
        ;;
      -R)
        [[ $# -ge 2 ]] || die "-R requires a repository argument"
        repo="$2"
        shift 2
        ;;
      -a | --all)
        include_resolved="true"
        shift
        ;;
      -*)
        die "Unknown option: $1"
        ;;
      *)
        if [[ -z "$pr_number" ]]; then
          pr_number="$1"
        else
          die "Unexpected argument: $1"
        fi
        shift
        ;;
    esac
  done

  [[ -n "$pr_number" ]] || die "PR number is required"

  repo=$(get_repo_from_arg_or_current "$repo")
  local owner repo_name
  owner=$(echo "$repo" | cut -d'/' -f1)
  repo_name=$(echo "$repo" | cut -d'/' -f2)

  # Fetch review threads using GraphQL
  local threads_json
  threads_json=$(fetch_review_threads "$owner" "$repo_name" "$pr_number" "$include_resolved")

  format_threads "$threads_json"
}

main "$@"
