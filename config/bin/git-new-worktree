#!/bin/bash
#
# git new-worktree - Create a new Git worktree for a branch
#
set -euo pipefail

usage() {
  cat << EOF
Usage: $0 [options] [--from <base-branch>] [<name>]

Options:
  -h, --help        Show this help message
  --from <branch>   Base branch for new branch creation (default: origin/main or origin/master)
  --force           Force create new branch even if it already exists

Arguments:
  <name>            worktree and branch name
EOF
  exit 1
}

from_branch=""
force_create=false
name=""

while (($#)); do
  case "$1" in
    -h | --help)
      usage
      ;;
    --from)
      [ $# -ge 2 ] || usage
      from_branch="$2"
      shift 2
      ;;
    --force)
      force_create=true
      shift
      ;;
    -*)
      echo "Unknown option: $1" >&2
      usage
      ;;
    *)
      # First non-option is treated as worktree name input
      name="$1"
      shift
      ;;
  esac
done

# remove fohte/ prefix to avoid fohte/fohte/<name>
name_no_prefix="${name#fohte/}"
# replace slashes with dashes
worktree_name="${name_no_prefix//\//-}"
worktree_dir="$(git root)/.worktrees/${worktree_name}"

# Use --from if specified, otherwise use main branch (e.g. origin/main or origin/master)
base_branch="${from_branch:-origin/$(git main)}"
branch="fohte/${name_no_prefix}"

git fetch -p

if [ "$force_create" = true ]; then
  git worktree add "$worktree_dir" -B "$branch" "$base_branch"
else
  git worktree add "$worktree_dir" -b "$branch" "$base_branch"
fi

# create a tmux window in the current session
tmux new-window -c "${worktree_dir}" -n "${worktree_name}" zsh
