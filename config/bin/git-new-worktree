#!/bin/bash
#
# git new-worktree - Create a new Git worktree for a branch
#
set -euo pipefail

usage() {
  cat << EOF
Usage: $0 [options] [--from <base-branch>] [<name>]

Options:
  -h, --help        Show this help message
  --from <branch>   Base branch for new branch creation (default: origin/main or origin/master)
  --force           Force create new branch even if it already exists

Arguments:
  <name>            Branch name (existing branch will be checked out,
                    non-existing branch will be created with fohte/ prefix)
EOF
  exit 1
}

from_branch=""
force_create=false
name=""

while (($#)); do
  case "$1" in
    -h | --help)
      usage
      ;;
    --from)
      [ $# -ge 2 ] || usage
      from_branch="$2"
      shift 2
      ;;
    --force)
      force_create=true
      shift
      ;;
    -*)
      echo "Unknown option: $1" >&2
      usage
      ;;
    *)
      # First non-option is treated as worktree name input
      name="$1"
      shift
      ;;
  esac
done

# Function to check if branch exists
branch_exists() {
  local branch="$1"
  # Check local branch
  if git show-ref --verify --quiet "refs/heads/$branch"; then
    return 0
  fi
  # Check remote branch
  if git show-ref --verify --quiet "refs/remotes/$branch"; then
    return 0
  fi
  return 1
}

# Determine worktree directory name from branch name
# remove fohte/ prefix to avoid fohte/fohte/<name>
name_no_prefix="${name#fohte/}"
# replace slashes with dashes
worktree_name="${name_no_prefix//\//-}"
worktree_dir="$(git root)/.worktrees/${worktree_name}"

git fetch -p

# Determine action based on branch existence and flags
if [ "$force_create" = true ]; then
  # Force create new branch with fohte/ prefix
  base_branch="${from_branch:-origin/$(git main)}"
  branch="fohte/${name_no_prefix}"
  git worktree add "$worktree_dir" -B "$branch" "$base_branch"
elif branch_exists "$name"; then
  # Branch exists, check it out as-is
  git worktree add "$worktree_dir" "$name"
else
  # Branch doesn't exist, create new one with fohte/ prefix
  base_branch="${from_branch:-origin/$(git main)}"
  branch="fohte/${name_no_prefix}"
  git worktree add "$worktree_dir" -b "$branch" "$base_branch"
fi

# create a tmux window in the current session
tmux new-window -c "${worktree_dir}" -n "${worktree_name}" zsh
