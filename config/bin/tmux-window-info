#!/usr/bin/env bash

set -euo pipefail

if [ -z "$TMUX" ]; then
  echo "This command must be run in tmux" >&2
  exit 1
fi

window_id="$1"

# Get session name
session_name=$(tmux display-message -p '#S')

# For vibe session, just show window name
if [ "$session_name" = "vibe" ]; then
  tmux display-message -p '#W'
  exit 0
fi

# Get the current working directory of the active pane
current_dir=$(tmux list-panes -t "$window_id" -F '#{pane_current_path}' | head -1)

# Check if current directory is a git worktree
is_worktree() {
  local dir="$1"
  if [ -f "${dir}/.git" ]; then
    # Check if .git is a file (worktree) rather than a directory
    if head -1 "${dir}/.git" 2> /dev/null | grep -q "^gitdir:"; then
      return 0
    fi
  fi
  return 1
}

if is_worktree "$current_dir"; then
  # use branch icon for git worktree and show worktree name (highest priority)
  worktree_name=$(basename "$current_dir")
  echo -e "\ue725 $worktree_name"
else
  case "$(tmux list-panes -t "$window_id" -F '#{pane_current_command}')" in
    *'nvim'*)
      # use vim icon instead of neovim icon (second priority)
      # so HackGen35 Console NF doesn't have the neovim icon
      echo -e '\ue7c5'
      ;;
    *)
      # terminal icon (lowest priority)
      echo -e '\uf120'
      ;;
  esac
fi
