#!/usr/bin/env bash
#
# vibe - Claude Code wrapper with tmux session and git worktree management
#
# Requirements:
#   - tmux
#   - git
#   - claude (Claude Code CLI)
#
# Usage:
#   vibe start <name>
#   vibe done [<name>] [--force|-f]
#
set -euo pipefail

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="${SCRIPT_DIR}/lib/vibe"

# Source library files
# shellcheck source=lib/vibe/common.bash
source "${LIB_DIR}/common.bash"
# shellcheck source=lib/vibe/git.bash
source "${LIB_DIR}/git.bash"
# shellcheck source=lib/vibe/tmux.bash
source "${LIB_DIR}/tmux.bash"
# shellcheck source=lib/vibe/commands.bash
source "${LIB_DIR}/commands.bash"

# Main script
[[ "$#" -lt 1 ]] && error_usage "missing command"

command="$1"
shift

# Main execution
# Verify prerequisites
verify_git_repo

# Get the main git directory (not worktree)
git_common_dir="$(git rev-parse --git-common-dir)"
git_root="$(dirname "${git_common_dir}")"
project_name="$(basename "${git_root}")"

SESSION_NAME="vibe"

# Parse command and get name
case "$command" in
  start)
    name=$(parse_start_command "$@")
    branch="claude/${name}"
    worktree_dir=".worktrees/${name}"
    worktree_path="${git_root}/${worktree_dir}"
    handle_start "${branch}" "${worktree_path}" "${worktree_dir}" "${SESSION_NAME}" "${project_name}"
    ;;
  done)
    parsed_output=$(parse_done_command "$@") || exit 1
    read -r name force <<< "$parsed_output"
    branch="claude/${name}"
    worktree_dir=".worktrees/${name}"
    worktree_path="${git_root}/${worktree_dir}"
    handle_done "${branch}" "${worktree_path}" "${worktree_dir}" "${force}" "${SESSION_NAME}" "${project_name}" "${git_root}"
    ;;
  *)
    error_usage "unknown command '$command'"
    ;;
esac
